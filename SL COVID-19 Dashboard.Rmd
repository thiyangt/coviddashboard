---
title: "SL COVID-19 Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
  
---

```{r setup, include=FALSE}

## r Packages

library(flexdashboard) # to dashboard interface
library(readr) # to read the files
library(tidyverse) # to data manipulation
library(plotly) # to interactive visualization
library(ggplot2) # to visualization
library(coronavirus) # to get coronavirus data
#library(sf) # to mapping
library(leaflet) # to mapping
library(leafpop) # to mapping

```


```{r}
# set colors

confirmed_clr <- "#7570b3"
recovered_clr <- "#1b9e77"
active_clr <- "purple"
death_clr <- "#d95f02"
wave1_clr <- "#8c96c6"
wave2_clr <- "#8856a7"
wave3_clr <- "#810f7c"
```


Overview  
=====================================================

#### **Last Updated at `r format(Sys.time()-86400, "%A %B %d, %Y")`**


Column 
-----------------------------------------------------------------------

```{r}

# Get Covid-19 data into R
Covid_cases <- read.csv("C:/Users/Randi/Desktop/Project/Project/Covid.cases.csv")

Covid_cases  <- Covid_cases [order(as.Date(Covid_cases$Date, format="%Y-%m-%d")), ] 

i <- 1:length(Covid_cases$Type)

# get daily counts
Covid_cases$daily <- Covid_cases$Count[i+4] - Covid_cases$Count[i]
Covid_cases$daily <- abs(Covid_cases$daily)

x <- Covid_cases %>%
  dplyr::filter(Date == max(Covid_cases$Date))

# Get Vaccine data set into R
Vaccine.data <- read.csv("C:/Users/Randi/Desktop/Project/Project/Vaccine.data.csv")

colnames(Vaccine.data)[which(names(Vaccine.data) %in% c("first.dose", "Second.dose"))] <- c("First Dose Only", "Fully Vaccinated")

Vaccine.data <- Vaccine.data[order(as.Date(Vaccine.data$Date, format="%Y-%m-%d")), ]

Vaccine_new <- Vaccine.data %>%
  pivot_longer(3:4, names_to = "dose", values_to = "count")

y <- Vaccine_new %>%
  filter(Date == max(Covid_cases$Date))

```


### Total Confirmed

```{r}
valueBox(value = format(x$Count[1], big.mark = ","), icon = "fas fa-ambulance", color = confirmed_clr)
```

### Total Recovered

```{r}
valueBox(value = format(x$Count[2], big.mark = ","), icon = "fas fa-home", color = recovered_clr)
```

### Total Death

```{r}
valueBox( value = format(x$Count[3], big.mark = ","), icon = "fas fa-heartbeat", color = death_clr)
```

### Total Active 

```{r}
valueBox( value = format(x$Count[4], big.mark = ","), icon = "fas fa-bed", color = active_clr)
```


### Total Vaccine doses administered

```{r}
valueBox( value = format(sum(y$count), big.mark = ","), icon = "fas fa-injection", color = "#a6761d")
```


```{r}

Confirmed <- Covid_cases %>%
  filter(Type == "Confirmed")

Recovered <- Covid_cases %>%
  filter(Type == "Recovered")

Deaths <- Covid_cases %>%
  filter(Type == "Deaths")

```


column 
------------------------------

### **Daily New COVID-19 Cases**

```{r}

g1 <- plot_ly(Confirmed) %>%
  add_lines(
    x = ~Date, y = ~daily, type = "line",
    line = list(color = confirmed_clr),
    name = "Confirmed"
  ) %>%
  layout(
    yaxis = list(title  = "Daily Confirmed Cases"),
    xaxis = list(title = "Date"),
    showlegend = FALSE
  )

g2 <- plot_ly(Recovered) %>%
  add_lines(
    x = ~Date, y = ~daily, type = "line",
    line = list(color = recovered_clr),
    name = "Recovered"
  ) %>%
  layout(
    yaxis = list(title  = "Daily Recovered Cases"),
    xaxis = list(title = "Date"),
    showlegend = FALSE
  )

g3 <- plot_ly(Deaths) %>%
  add_lines(
    x = ~Date, y = ~daily, type = "line",
    line = list(color = death_clr),
    name = "Deaths"
  ) %>%
  layout( 
    yaxis = list(title  = "Daily Death Cases"),
    xaxis = list(title = "Date"),
    showlegend = FALSE
  )

subplot(g1, g2, g3, nrows  = 1, shareX = TRUE, titleY = TRUE, margin = 0.03) %>%
  layout(annotations = list(
    list(x = 0.05, y = 1.05, text = "Daily New COVID-19 Confirmed Cases", showarrow = F, xref = 'paper', yref = 'paper'),
    list(x = 0.5, y = 1.05, text = "Daily New COVID-19 Recovered Cases", showarrow = F, xref = 'paper', yref = 'paper'),
    list(x = 0.9, y = 1.05, text = "Daily New COVID-19 Death Cases", showarrow = F, xref = 'paper', yref = 'paper')
  ))

```


Cases by Wave 
========================================================

column{.tabset}
----------------------------------------------

### **Total COVID-19 Confirmed Cases**


```{r}

Confirmed <- Covid_cases %>%
  filter(Type == "Confirmed")

# Assign wave by considering date
Confirmed$Wave = lapply(Confirmed$Date, FUN = function(x){
  x = as.Date(x)
  if(as.Date("2020-03-29") <= x & x <= as.Date("2020-10-03")){
    return("First Wave")
  } else if (as.Date("2020-10-04") <= x & x <= as.Date("2021-04-14")){
    return("Second Wave")
  } else {
    return("Third Wave")
  } 
})

Confirmed$Wave <- as.character(Confirmed$Wave)

plot_ly(Confirmed, x = ~Date, 
        y = ~Count, 
        type = "scatter", 
        mode = "lines+markers", 
        color = ~Wave, colors = c('First Wave' = wave1_clr, 'Second Wave' = wave2_clr, 'Third Wave' = wave3_clr),
        showlegend = TRUE) %>%
  layout(
    yaxis = list(title  = "Cumulative Count"))%>%
  add_segments(y = 0, 
               yend = max(Confirmed$Count),
               x = as.Date("2020-06-28"), 
               xend = as.Date("2020-06-28"), 
               line = list(dash = "dot", color = "black", width = 1),
               showlegend = FALSE) %>%
  add_annotations(
    x = as.Date("2020-06-23"),
    y = 150000,
    text = 'Lifted the COVID-19 Curfew',
    textangle = '270',
    font = list(size = 12, color = "black"),
    showarrow = FALSE
  )%>%
  add_segments(y = 0, 
               yend = max(Confirmed$Count),
               x = as.Date("2020-08-05"), 
               xend = as.Date("2020-08-05"), 
               line = list(dash = "dot", color = "black", width = 1),
               showlegend = FALSE) %>%
  add_annotations(
    x = as.Date("2020-07-31"),
    y = 150000,
    text = 'Held the Parlimentary Elections',
    textangle = '270',
    font = list(size = 12, color = "black"),
    showarrow = FALSE
  )  %>%
  add_segments(y = 0, 
               yend = max(Confirmed$Count), 
               x = as.Date("2020-10-04"), 
               xend = as.Date("2020-10-04"), 
               line = list(dash = "dot", color = "black", width = 1),
               showlegend = FALSE) %>%
  add_annotations(
    x = as.Date("2020-09-29"),
    y = 150000,
    text = 'Announced as a Second wave & Closed All Schools',
    textangle = '270',
    font = list(size = 12, color = "black"),
    showarrow = FALSE
  ) %>%
  add_segments(y = 0, 
               yend = max(Confirmed$Count), 
               x = as.Date("2020-10-29"), 
               xend = as.Date("2020-10-29"), 
               line = list(dash = "dot", color = "black", width = 1),
               showlegend = FALSE) %>%
  add_annotations(
    x = as.Date("2020-10-24"),
    y = 150000,
    text = 'Imposed Curfew in the Entire Western Province',
    textangle = '270',
    font = list(size = 12, color = "black"),
    showarrow = FALSE
  ) %>%
  add_segments(y = 0, 
               yend = max(Confirmed$Count), 
               x = as.Date("2021-01-29"), 
               xend = as.Date("2021-01-29"), 
               line = list(dash = "dot", color = "black", width = 1),
               showlegend = FALSE) %>%
  add_annotations(
    x = as.Date("2021-01-25"),
    y = 150000,
    text = 'Began the Vaccination of Health and Frontline Workers',
    textangle = '270',
    font = list(size = 12, color = "black"),
    showarrow = FALSE
  ) %>%
  add_segments(y = 0, 
               yend = max(Confirmed$Count), 
               x = as.Date("2021-04-15"), 
               xend = as.Date("2021-04-15"), 
               line = list(dash = "dot", color = "black", width = 1),
               showlegend = FALSE) %>%
  add_annotations(
    x = as.Date("2021-04-10"),
    y = 150000,
    text = 'Annonced a Risk Alert Level 3',
    textangle = '270',
    font = list(size = 12, color = "black"),
    showarrow = FALSE
  ) %>%
  add_segments(y = 0, 
               yend = max(Confirmed$Count), 
               x = as.Date("2021-05-06"), 
               xend = as.Date("2021-05-06"), 
               line = list(dash = "dot", color = "black", width = 1),
               showlegend = FALSE) %>%
  add_annotations(
    x = as.Date("2021-05-01"),
    y = 150000,
    text = 'Closed Borders to India',
    textangle = '270',
    font = list(size = 12, color = "black"),
    showarrow = FALSE
  ) %>%
  add_segments(y = 0, 
               yend = max(Confirmed$Count), 
               x = as.Date("2021-05-10"), 
               xend = as.Date("2021-05-10"), 
               line = list(dash = "dot", color = "black", width = 1),
               showlegend = FALSE) %>%
  add_annotations(
    x = as.Date("2021-05-07"),
    y = 175000,
    text = 'Imposed inter Provincial Travel Restriction ',
    textangle = '270',
    font = list(size = 12, color = "black"),
    showarrow = FALSE
  ) %>%
  add_segments(y = 0, 
               yend = max(Confirmed$Count), 
               x = as.Date("2021-06-17"), 
               xend = as.Date("2021-06-17"), 
               line = list(dash = "dot", color = "black", width = 1),
               showlegend = FALSE) %>%
  add_annotations(
    x = as.Date("2021-06-12"),
    y = 150000,
    text = 'Identified the First Cases Infected by Delta Variant',
    textangle = '270',
    font = list(size = 12, color = "black"),
    showarrow = FALSE
  ) 
```


### **COVID-19 Cases Distribution by Wave**

```{r}
x1 <- Confirmed %>%
  filter(Wave == "First Wave")

g4 <- plot_ly(x1) %>%
  add_bars(
    x = ~Date, y = ~daily, type = "bar",
    marker = list(color = wave1_clr),
    name = "First wave"
  ) %>%
  layout(
    yaxis = list(title  = "Daily Confirmed Cases"),
    xaxis = list(title = "Date"),
    showlegend = FALSE
  )


x2 <- Confirmed %>%
  filter(Wave == "Second Wave")

g5 <- plot_ly(x2) %>%
  add_bars(
    x = ~Date, y = ~daily, type = "bar",
    marker = list(color = wave2_clr),
    name = "Second wave"
  ) %>%
  layout(
    yaxis = list(title  = "Daily Confirmed Cases"),
    xaxis = list(title = "Date"),
    showlegend = FALSE
  )

x3 <- Confirmed %>%
  filter(Wave == "Third Wave")

g6 <- plot_ly(x3) %>%
  add_bars(
    x = ~Date, y = ~daily, type = "bar",
    marker = list(color = wave3_clr),
    name = "Third wave"
  ) %>%
  layout(
    yaxis = list(title  = "Daily Confirmed Cases"),
    xaxis = list(title = "Date"),
    showlegend = FALSE
  )

subplot(g4, g5, g6, nrows  = 1, shareX = TRUE, titleY = TRUE, margin = 0.03) %>%
  layout(annotations = list(
    list(x = 0.1, y = 1.05, text = "First Wave", showarrow = F, xref = 'paper', yref = 'paper'),
    list(x = 0.5, y = 1.05, text = "Second Wave", showarrow = F, xref = 'paper', yref = 'paper'),
    list(x = 0.85, y = 1.05, text = "Third Wave", showarrow = F, xref = 'paper', yref = 'paper')
  ))

```


COVID-19 Patients Distribution
================================================================================

column{.tabset}
--------------------------------------------------------------------------------


```{r}

# Get District wise data 
June_Covid <- read.csv("C:/Users/Randi/Desktop/Project/Project/Covid.June.csv")
June_Covid <- June_Covid[order(as.Date(June_Covid$Date, format="%Y-%m-%d")), ]

# Get total count for each district
June_30 <- tail(June_Covid, 26)

```

### **Total COVID-19 Patients Distribution in Sri Lanka (upto 30th June 2021)**


```{r}

Covid <- June_30 %>%
  mutate(District = case_when(
    District == "Kurunagala" ~ "Kurunegala",
    TRUE ~ District
  ))

Covidnew <- Covid %>%
  mutate(parents = "Confirmed")

plot_ly(
    data = Covidnew,
     type="treemap",
     labels = ~ District,
    parents = ~ parents,
     values = ~ Count,
    domain = list(column = 0),
    textinfo = "label+value+ percent parent"
  ) 

```


### **Country Map**

```{r}
# Get geometries of sri Lanka related to districts.
SL_shp <- read_sf("C:/Users/Randi/Desktop/Project/Project/lka_admbnda_adm2_slsd_20200305.shp") %>%
  select(ADM2_EN, geometry)
SL <- SL_shp %>% st_transform(5235)

SL <- SL%>%
  rename(District = ADM2_EN)

Covid_SL <- left_join(SL, Covid, by = c("District"))

Ampara <- Covid%>%
  filter(District %in% c("Kalmunai","Ampara" ))
newcount <- Ampara$Count %>%
  sum()

Covid_SL <- Covid_SL %>%
  filter(!(District == "[unknown]")) %>%
  filter(!(District == "Kalmunai")) %>%
  mutate(Count = ifelse(District == "Ampara", newcount, Count))

p1 <- ggplot(Covid_SL)+
  geom_sf(aes(fill = Count, text = paste('District:', District)))+
  scale_fill_distiller(type = "seq",
                       palette = "YlOrBr",
                       breaks = c(5000, 10000, 20000, 30000, 40000, 50000, 60000),
                       limits = c(min(Covid_SL$Count), max(Covid_SL$Count)),
                       direction = -1)+
  ggtitle("Map for COVID-19 Cases")+
  theme(plot.title = element_text(hjust = 0.5))

ggplotly(p1)
```


### **Distribution of Daily COVID-19 Patients For Last 30days (For June -2021)**


```{r}

i <- 1:length(June_Covid$District)
June_Covid$daily <- June_Covid$Count[i+26] - June_Covid$Count[i]
June_Covid$Date <- as.Date(June_Covid$Date)
June_Covid <- head(June_Covid, -26)

colors <- c('black', 'darkmagenta', 'darkorange1')

June_Covid_new <- June_Covid %>%
  arrange(Count) %>%
  mutate(District = fct_inorder(factor(District, ordered = TRUE)))

ggplotly(ggplot(June_Covid_new, aes(Date, District)) + 
           geom_tile(aes(fill = daily))+
           scale_fill_gradientn(limits = c(0, 800), 
                                colors = colors,  
                                breaks = c(0, 200, 400, 600, 800))+ 
           scale_x_date(date_breaks = '1 week', date_labels = "%d-%b-%Y"))


```


### **By Applying Min-max Transformation**

```{r, echo=FALSE}

cov_june <- as.data.frame(June_Covid)

District <- c(cov_june$District[1:26])
data <- cov_june

# Apply min-max transformation for each district separately
covid <- function(data, District){
  results <- list(1:26)
  for(i in 1: length(District)){
    x <- filter(data, District == District[i])
    j <- 1:30
    y <- x$daily
    x$min_max <-(y[j] - min(y))/(max(y) - min(y))
    results[[i]] <- x
  }
  return(results)
}

Data <- covid(data, District)
District_data <- do.call(rbind, Data)

June_Covid_new_1 <- District_data %>%
  arrange(Count) %>%
  mutate(District = fct_inorder(factor(District, ordered = TRUE)))

# Give colors manually
colors <- c('black', 'darkmagenta', 'darkorange1')

ggplotly(ggplot(June_Covid_new_1, aes(Date, District)) + 
           geom_tile(aes(fill = min_max))+ 
           scale_fill_gradientn(limits = c(0, 1), colors = colors,  
                                breaks = c(0, 0.25, 0.5, 0.75, 1))+ 
           scale_x_date(date_breaks = '1 week', date_labels = "%d-%b-%Y"))

```

Vaccination Details 
========================================================================

column
-----------------------------------------

```{r}
# Get total vaccine counts
Vaccine_new_data <- tail(Vaccine_new, 6)
Vaccine_new_data <- Vaccine_new_data %>% group_by(Vaccine) %>%
  mutate(percentage = round(count/sum(count)*100, 2))

```

### **Count of Vaccination by Vaccine Name**

```{r}
plot_ly(Vaccine_new_data, 
        x = ~count, 
        y = ~reorder(Vaccine, count), 
        type = 'bar', 
        color = ~dose, 
        colors = c('First Dose Only' = '#d01c8b', 'Fully Vaccinated' = '#4dac26')) %>% layout(title = "Vaccination Counts", yaxis = list(title  = list(text = "Vaccine Name", standoff = 10)),  barmode = "stack")

```


### **Proportion of Vaccination by Vaccine Name**

```{r}
plot_ly(Vaccine_new_data, 
        x = ~percentage, 
        y = ~reorder(Vaccine, count), 
        type = 'bar', 
        color = ~dose, 
        colors = c('First Dose Only' = '#d01c8b', 'Fully Vaccinated' = '#4dac26')) %>%
  layout(title = "Propotion of Vaccination" ,xaxis = list(title = 'Percentage(%)'),  yaxis = list(title  = list(text = "Vaccine Name", standoff = 10)), barmode = "stack") 
```


Top 10 Countries 
=========================================================

column{.tabset}
-----------------
  

```{r}
datacov <- read.csv("https://covid19.who.int/WHO-COVID-19-global-data.csv")

new <- datacov %>%
  filter(Country%in% c("United States of America", "India", "Brazil", "Russian Federation", 
                       "France", "The United Kingdom", "	Turkey", "Argentina", "Colombia", "Spain", "Sri Lanka"))
cov <- new[, c(1, 3,5, 6, 7, 8)]

names(cov) <- c("Date", "Country", "Daily cases", "Cumalative cases", "Daily deaths", "Cumalative deaths")

cov$Country <- factor(cov$Country, levels = c("United States of America", "India", "Brazil", "Russian Federation", "France", "The United Kingdom", "	Turkey", "Argentina", "Colombia", "Spain","Iran (Islamic Republic of)" , "Sri Lanka"))

colors <- c("#543005", "#8c510a", "#bf812d", "#dfc27d", "#f6e8c3", "#762a83", "#80cdc1", "#35978f", "#01665e", "#003c30", "#ca0020")


```

### **Comparison of Cumulative Cases in Sri Lanka  with Top 10 Countries (Linear)**

```{r}
g7 <- plot_ly(cov) %>%
  add_lines(
    x = ~Date, 
    y = ~cov$`Cumalative cases`, 
    type = "scatter", 
    mode = "lines+markers",
    color = ~ Country, colors = colors,
    showlegend = TRUE
  ) %>%
  layout(yaxis = list(title  = "Cumulative Confirmed Count"),
    xaxis = list(title = "Date")
  )

g8 <- plot_ly(cov) %>%
  add_lines(
    x = ~Date, 
    y = ~cov$`Cumalative deaths`, 
    type = "scatter", 
    mode = "lines+markers",
    color = ~ Country, 
    colors = colors,
    showlegend = FALSE
  ) %>%
  layout(yaxis = list(title  = "Cumulative Deaths Count"),
    xaxis = list(title = "Date")
  )


subplot(g7, g8, nrows  = 1, shareX = TRUE, titleY = TRUE, margin = 0.03) %>%
          layout(annotations = list(
            list(x = 0.09, y = 1.05, text = "Total COVID-19 Confirmed Cases", showarrow = F, xref = 'paper', yref = 'paper'),
            list(x = 0.85, y = 1.05, text = "Total COVID-19 Deaths", showarrow = F, xref = 'paper', yref = 'paper')
          ))

```

### **Comparison of Log value of Cumulative Counts in Sri Lanka with Top 10 Countries (Log)**

```{r}
g9 <- plot_ly(cov) %>%
  add_lines(
    x = ~Date, 
    y = ~cov$`Cumalative cases`, 
    type = "scatter", 
    mode = "lines+markers",
    color = ~ Country, 
    colors = colors,
    showlegend = TRUE
  ) %>%
  layout(yaxis = list(title  = "Log Cumulative Confirmed Count", type = "log"),
         xaxis = list(title = "Date")
  )

g10 <- plot_ly(cov) %>%
  add_lines(
    x = ~Date, 
    y = ~cov$`Cumalative deaths`, 
    type = "scatter", 
    mode = "lines+markers",
    color = ~ Country, 
    colors = colors,
    showlegend = FALSE
  ) %>%
  layout(yaxis = list(title  = "Log Cumulative Death Count", type = "log"),
         xaxis = list(title = "Date")
  )

subplot(g9, g10, nrows  = 1, shareX = TRUE, titleY = TRUE, margin = 0.03) %>%
          layout(annotations = list(
            list(x = 0.09, y = 1.05, text = "Total COVID-19 Confirmed Cases", showarrow = F, xref = 'paper', yref = 'paper'),
            list(x = 0.85, y = 1.05, text = "Total COVID-19 Deaths", showarrow = F, xref = 'paper', yref = 'paper')
          ))
```



Global Comparison
=============================================


```{r}
# Refresh the coronavirus package to get new data
covid19 <- refresh_coronavirus_jhu()

cv_data <- covid19 %>%
  dplyr::filter(value > 0) %>%
  dplyr::group_by(location, lat,long, data_type) %>%
  dplyr::summarise(cases = sum(value)) 

global <-cv_data %>% 
  filter(location  %in% c("US", "India", "Brazil", "Russia", "France", "United Kingdom", "Turkey", "Argentina", "Colombia", "Spain", "Sri Lanka")) %>%
  filter(data_type %in% c("cases_new", "deaths_new"))

Asia <- cv_data %>%
  filter(location  %in% c("India", "Sri Lanka", "Bangladesh", "Pakistan", "Iran", "Indonesia", "Philippines", "Iraq", "Malaysia", "Japan", "Tailand")) %>%
  filter(data_type %in% c("cases_new", "deaths_new"))

global_new <- pivot_wider(global, names_from = data_type, values_from = cases)
global_new <- global_new %>%
  mutate(rate = round(deaths_new/cases_new*100, 2))

Asia_new <- pivot_wider(Asia, names_from = data_type, values_from = cases)
Asia_new <- Asia_new %>%
  mutate(rate = round(deaths_new/cases_new*100, 2))

```


column{.tabset}
------------------------------------

### **Comparison of Sri Lanka with Top 10 Countries Reporting the Most COVID-19 Cases in the World **


```{r}
g11 <- plot_ly(global, 
               x = ~cases, 
               y = ~reorder(location, cases), 
               type = 'bar', 
               color = ~data_type, 
               colors = c('cases_new' = confirmed_clr, 'deaths_new' = death_clr)) %>%
  layout(xaxis = list(title = 'Count'),   yaxis = list(title  = list(text = "Country", standoff = 10)), barmode = "stack", legend = list(orientation = "h",xanchor = "center",x = 0.5 ))
                                                                                                                                         
g12 <- plot_ly(global_new, 
               x = ~rate, 
               y = ~reorder(location, rate), 
               type = 'bar', 
               marker = list(color = "brown"), 
               name = "Death Rate", 
               showlegend = FALSE) %>%
  layout(xaxis = list(title = 'Death Rate (%)'), yaxis = list(title  = list(text = "Country", standoff = 10)))

subplot(g11, g12, nrows  = 1, titleX = TRUE, titleY = TRUE, margin = 0.05) %>%
  layout(annotations = list(
    list(x = 0.09, y = 1.05, text = "Number of Cases Per Country", showarrow = F, xref = 'paper', yref = 'paper'),
    list(x = 0.85, y = 1.05, text = "Case-Fatality Ratio Per Country", showarrow = F, xref = 'paper', yref = 'paper')
  ))

```

### **Comparison of Sri Lanka with Top 10 Countries Reporting the Most COVID-19 Cases in the Asia**

```{r}
g13 <- plot_ly(Asia, 
               x = ~cases, 
               y = ~reorder(location, cases), 
               type = 'bar', 
               color = ~data_type, 
               colors = c('cases_new' = confirmed_clr, 'deaths_new' = death_clr)) %>%
  layout(xaxis = list(title = 'Count'),   yaxis = list(title  = list(text = "Country", standoff = 10)), barmode = "stack", legend = list(orientation = "h",xanchor = "center",x = 0.5 ))

g14 <- plot_ly(Asia_new, 
               x = ~rate, 
               y = ~reorder(location, rate), 
               type = 'bar', 
               marker = list(color = "brown"), 
               name = "Death Rate", 
               showlegend = FALSE) %>%
  layout(xaxis = list(title = 'Death Rate (%)'), yaxis = list(title  = list(text = "Country", standoff = 10)))

subplot(g13, g14, nrows  = 1, titleX = TRUE, titleY = TRUE, margin = 0.05) %>%
  layout(annotations = list(
    list(x = 0.09, y = 1.05, text = "Number of Cases Per Country", showarrow = F, xref = 'paper', yref = 'paper'),
    list(x = 0.85, y = 1.05, text = "Case-Fatality Ratio Per Country", showarrow = F, xref = 'paper', yref = 'paper')
  ))

```


Global Map
===========================================


### **Spread of COVID-19 cases in World (by `r format(max(covid19$date), "%A %B %d, %Y")`)**

```{r}
# Correction of longitude 

cv_data$long[cv_data$long == 149.4068] <- -149.4068

cv_data_for_plot <- cv_data %>%
  dplyr::mutate(log_cases = 2 * log(cases)) %>%
  dplyr::ungroup()

cv_data_for_plot.split <- cv_data_for_plot %>% split(cv_data_for_plot$data_type)
pal <- colorFactor(c(confirmed_clr, death_clr, recovered_clr), domain = c("cases_new", "deaths_new", "recovered_new"))
map_object <- leaflet() %>% addProviderTiles(providers$Stamen.Toner)
names(cv_data_for_plot.split) %>%
  purrr::walk(function(df) {
    map_object <<- map_object %>%
      addCircleMarkers(
        data = cv_data_for_plot.split[[df]],
        lng = ~long, lat = ~lat,
        # label=~as.character(cases),
        color = ~ pal(data_type),
        stroke = FALSE,
        fillOpacity = 0.8,
        radius = ~log_cases,
        popup = leafpop::popupTable(cv_data_for_plot.split[[df]],
                                    feature.id = FALSE,
                                    row.numbers = FALSE,
                                    zcol = c("data_type", "cases", "location")
        ),
        group = df,
        #                 clusterOptions = markerClusterOptions(removeOutsideVisibleBounds = F),
        labelOptions = labelOptions(
          noHide = F,
          direction = "auto"
        )
      )
  })
map_object %>%
  addLayersControl(
    overlayGroups = names(cv_data_for_plot.split),
    options = layersControlOptions(collapsed = FALSE)
  )

```


About
===================================================

**Created by**

Under supervision of Dr.Thiyanga Thalagala this dashboard was created by Randi Shashikala De Alwis.

This dashboard provides an overview of the COVID-19 pandemic for Sri Lanka. Dashboard is built with R using the R Markdown framework.

**Data**

All input data (related to the local situation) for the dashboard is pulled from COVID-19 daily situation reports published by Epidemiology Unit, Ministry of Health and Indigenous Medical Services, Sri Lanka.[Here](https://www.epid.gov.lk/web/index.php?option=com_content&view=article&id=225&Itemid=518&lang=en)

The global data is pulled from the John Hopkins University Center for System Science and Engineering (JHU ccsE) Coronavirus repository (through coronavirus package in R) and World Heath Organization.[Here](https://covid19.who.int/WHO-COVID-19-global-data.csv)

**Remarks**

Proportion of Vaccination(for first dose only) = (Count of first doses administrated by corresponding vaccine/ Total doses administrated by corresponding vaccine) * 100.

Case-Fatality Ratio(%) = (Number of reported deaths/ Number of reported cases)*100.

In Sri Lanka country map both Kalmunai & Ampara districts counts are taken as count of Ampara.

Countries with the highest number of confirmed cases (as 31st August 2021) were selected as top 10 countries.

**Update**

The map data & global comparison data is as of `r format(max(covid19$date), "%A %B %d, %Y")` and the dashboard has been updated on `r format(Sys.time()-86400, "%A %B %d, %Y")`.

Local data is as of 01st of July 2021.  

 
